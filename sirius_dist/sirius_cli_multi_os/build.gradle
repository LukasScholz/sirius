import java.nio.file.Files

dependencies {
    compile project(':sirius_cli')
//    compile "de.unijena.bioinf.ms:ft_glpk:$siriusVersion"
    compile group: 'org.slf4j', name: 'slf4j-jdk14', version: "$slf4j_version"
}

task linux64Dist(type: Download, group: 'download') {
    String distName = "sirius-$version-linux64-headless"
    src "https://bio.informatik.uni-jena.de/repository/${version.toString().endsWith('-SNAPSHOT') ? 'dist-snapshot-local' : 'dist-release-local'}/de/unijena/bioinf/ms/sirius/$version/${distName}.zip"
    dest buildDir.toPath().resolve("tmp/source-dists/${distName}.zip").toFile()
    onlyIfModified true
    overwrite false

    doLast {
        copy {
            from zipTree(dest)
            into buildDir.toPath().resolve("tmp/source-dists").resolve(distName).toFile()
        }
    }
}

task osx64Dist(type: Download, group: 'download') {
    String distName = "sirius-$version-osx64-headless"
    src "https://bio.informatik.uni-jena.de/repository/${version.toString().endsWith('-SNAPSHOT') ? 'dist-snapshot-local' : 'dist-release-local'}/de/unijena/bioinf/ms/sirius/$version/${distName}.zip"
    dest buildDir.toPath().resolve("tmp/source-dists/${distName}.zip").toFile()
    onlyIfModified true
    overwrite false

    doLast {
        copy {
            from zipTree(dest)
            into buildDir.toPath().resolve("tmp/source-dists").resolve(distName).toFile()
        }
    }
}

task win64Dist(type: Download, group: 'download') {
    String distName = "sirius-$version-win64-headless"
    src "https://bio.informatik.uni-jena.de/repository/${version.toString().endsWith('-SNAPSHOT') ? 'dist-snapshot-local' : 'dist-release-local'}/de/unijena/bioinf/ms/sirius/$version/${distName}.zip"
    dest buildDir.toPath().resolve("tmp/source-dists/${distName}.zip").toFile()
    onlyIfModified true
    overwrite false

    doLast {
        copy {
            from zipTree(dest)
            into buildDir.toPath().resolve("tmp/source-dists").resolve(distName).toFile()
        }
    }
}

task multiOSImage(group: 'distribution') {
    dependsOn("linux64Dist", "osx64Dist", "win64Dist")
    inputs.files(osx64Dist.outputs.files.singleFile.toString().replace(".zip", ""), linux64Dist.outputs.files.singleFile.toString().replace(".zip", ""))
    outputs.file(getBuildDir().toPath().resolve("distributions").resolve(project.name))

    doFirst {
        copy {
            from(win64Dist.outputs.files.singleFile.toString().replace(".zip", "") + '/sirius') {
                exclude 'sirius.exe'
                exclude 'sirius-gui.exe'
                exclude 'sirius-gui.exe'
                exclude 'COPYING.txt'
                exclude 'LICENSE.txt'
                exclude "manual-$version-manual.pdf"
                exclude "app"
            }
            into outputs.files.singleFile.toPath().resolve(win64Dist.outputs.files.singleFile.getName().replace(".zip", ""))
        }

        copy {
            from(linux64Dist.outputs.files.singleFile.toString().replace(".zip", "") + '/sirius') {
                exclude 'bin/sirius'
                exclude 'COPYING.txt'
                exclude 'LICENSE.txt'
                exclude "manual-$version-manual.pdf"
                exclude "lib/app"
            }
            into outputs.files.singleFile.toPath().resolve(linux64Dist.outputs.files.singleFile.getName().replace(".zip", ""))
        }

        copy {
            from(osx64Dist.outputs.files.singleFile.toString().replace(".zip", "") + '/sirius.app/Contents') {
                exclude "app"
                exclude 'MacOs'
                exclude 'COPYING.txt'
                exclude 'LICENSE.txt'
                exclude "manual-$version-manual.pdf"
                exclude 'Info.plist'
                exclude 'PkgInfo'
            }
            into outputs.files.singleFile.toPath().resolve(osx64Dist.outputs.files.singleFile.getName().replace(".zip", ""))
        }

        copy {
            from(linux64Dist.outputs.files.singleFile.toString().replace(".zip", "") + '/sirius') {
                include 'COPYING.txt'
                include 'LICENSE.txt'
                include "manual-$version-manual.pdf"
            }
            from(linux64Dist.outputs.files.singleFile.toString().replace(".zip", "") + '/sirius/lib') {
                include "app"
            }
            into outputs.files.singleFile
        }

        //modify windows script
        /*def lines = Files.readAllLines(outputs.files.singleFile.toPath().resolve(win64Dist.outputs.files.singleFile.getName().replace(".zip", "")).resolve('sirius.bat'))
        outputs.files.singleFile.toPath().resolve(win64Dist.outputs.files.singleFile.getName().replace(".zip", "")).resolve('sirius.bat').toFile().withWriter {
            lines.forEach( {l ->
                if (l.startsWith("set JAR_HOME="))
                    it.writeLine('set JAR_HOME=%APP_HOME%\\..\\app')
                else
                    it.writeLine(l)
            })
        }

        lines = Files.readAllLines(outputs.files.singleFile.toPath().resolve(linux64Dist.outputs.files.singleFile.getName().replace(".zip", "")).resolve('bin/sirius.sh'))
        outputs.files.singleFile.toPath().resolve(linux64Dist.outputs.files.singleFile.getName().replace(".zip", "")).resolve('sirius.sh').toFile().withWriter {
            lines.forEach( {l ->
                if (l.startsWith("JAR_HOME="))
                    it.writeLine('JAR_HOME="\$APP_HOME/../app"')
                else
                    it.writeLine(l)
            })
        }

        lines = Files.readAllLines(outputs.files.singleFile.toPath().resolve(osx64Dist.outputs.files.singleFile.getName().replace(".zip", "")).resolve('sirius.sh'))
        outputs.files.singleFile.toPath().resolve(osx64Dist.outputs.files.singleFile.getName().replace(".zip", "")).resolve('sirius.sh').toFile().withWriter {
            lines.forEach( {l ->
                if (l.startsWith("JAR_HOME="))
                    it.writeLine('JAR_HOME="\$APP_HOME/../app"')
                else
                    it.writeLine(l)
            })
        }*/
    }


}

task multiOSImageZip(dependsOn: multiOSImage, group: 'distribution') {
    inputs.dir(multiOSImage.outputs)
    outputs.file(multiOSImage.outputs.files.singleFile.toString() + ".zip")
    doFirst {
        def imageDir = inputs.files.singleFile
        def parentPath = imageDir.parentFile.toPath()
        def zipFile = parentPath.resolve("${imageDir.getName()}.zip")
        project.ant.zip(destfile: zipFile, duplicate: 'fail') {
            imageDir.eachFileRecurse { f ->
                int mode = f.canExecute() ? 755 : 644
                def relPath = parentPath.relativize(f.toPath()).toString()
                zipfileset(dir: parentPath, includes: relPath, filemode: mode)
            }
        }
    }
}


distribution.dependsOn 'multiOSImage'
distribution.dependsOn 'multiOSImageZip'

publishing {
    publications {
        sirius(org.gradle.api.publish.maven.MavenPublication) {
            artifactId = "$name"
            groupId = "$group"
            artifact source: "${multiOSImageZip.outputs.files.singleFile}", classifier: "multiOS-headless", extension: 'zip'
        }
    }
}